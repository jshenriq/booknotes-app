<%- include("partials/header", { title: book.title }) %>

<!-- Book info -->
<section class="relative flex flex-col p-4 mb-4 bg-white rounded-lg shadow">
  <!-- Wrapper for Cover + Info Area -->
    <div class="flex items-start w-full gap-4">
      
      <!-- Cover (Fixed width) -->
      <div class="flex-shrink-0 w-20 h-28">
        <% if (book.isbn) { %>
          <img 
            src="https://covers.openlibrary.org/b/isbn/<%= book.isbn %>-M.jpg"
            alt="<%= book.title %>"
            class="object-cover w-full h-full rounded"
          />
        <% } else { %>
          <div class="flex items-center justify-center w-20 text-xs text-gray-500 bg-gray-200 rounded h-28">
            no cover
          </div>
        <% } %>
      </div>

      <!-- Info Area (Flex-grow takes remaining space, content inside is stacked using flex-col) -->
      <div class="flex flex-col flex-grow">
        <h2 class="text-lg font-semibold leading-tight"><%= book.title %></h2>
        <p class="text-sm text-gray-500"><%= book.author %></p>

        <div class="flex items-center gap-2 mt-2">
          <span class="text-sm font-medium">Rating:</span>
          <span class="text-yellow-500">
            <%= "★".repeat(book.rating) %>
            <%= "☆".repeat(5 - book.rating) %>
          </span>
        </div>
        
        <!-- Description -->
        <% if (book.description) { %>
          <p class="mt-2 text-sm text-gray-700 line-clamp-2">
            <%= book.description %>
          </p>
        <% } %>
      </div>
    </div> 
    
    <!-- Actions -->
    <form
      id="deleteBookForm"
      action="/books/<%= book.id %>/delete"
      method="POST"
      class="mt-4"
    >
      <button
        type="button"
        onclick="openModal()"
        class="w-full px-4 py-2 text-sm font-medium text-white bg-red-600 rounded hover:bg-red-700 "
      >
        Delete book
      </button>
    </form>
  
</section>

<!-- Notes section -->
<section class="p-4 bg-white rounded-lg shadow">
  <h2 class="mb-4 text-lg font-semibold">My Notes</h2>

  <% if (book.notes) { %>
    <!-- Display note -->
    <p id="noteText" class="mb-4 text-gray-700 break-all whitespace-pre-line">
      <%= book.notes %>
    </p>

    <!-- Edit button -->
     <div class="flex gap-4 mt-6">
    <button
      id="editBtn"
      onclick="enableEdit()"
      class="text-sm text-blue-600 hover:underline"
    >
      Edit note
    </button>

    <form action="/notes/<%= book.id %>/delete" method="POST">
        <button type="submit" class="text-sm text-red-600 hover:underline">
          Delete note
        </button>
      </form>
      </div>

  <% } else { %>
    <p class="mb-4 text-gray-500">No notes yet.</p>

    <button
      id="addBtn"
      onclick="enableEdit()"
      class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded hover:bg-blue-700"
    >
      Add note
    </button>
  <% } %>

  <!-- Edit form (hidden by default) -->
  <form
    id="editForm"
    action="/notes/<%= book.id %>"
    method="POST"
    class="hidden mt-4 space-y-4"
  >
    <!-- Notes -->
    <textarea
      name="notes"
      rows="4"
      class="w-full p-2 text-sm border rounded focus:outline-none focus:ring focus:border-blue-400"
    >
<%= book.notes || "" %></textarea
    >

    <!-- Rating -->
    <div>
      <label class="block mb-1 text-sm font-medium">Rating</label>
      <select name="rating" class="p-2 text-sm border rounded">
        <% for (let i=1; i <=5; i++) { %>
        <option value="<%= i %>" <%=book.rating===i ? "selected" : "" %>>
            <%= i %>
        </option>
        <% } %>
    </select>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <button
        type="submit"
        class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700"
      >
        Done
      </button>

      <% if (book.notes) { %>
      <form action="/notes/<%= book.id %>/delete" method="POST">
        <button type="submit" class="text-sm text-red-600 hover:underline">
          Delete note
        </button>
      </form>
      <% } %>
    </div>
  </form>

  <!-- Delete confirmation modal -->
<div
  id="confirmModal"
  class="fixed inset-0 z-50 items-center justify-center hidden bg-black/50"
>
  <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-lg">
    <h3 class="mb-2 text-lg font-semibold text-gray-900">
      Delete book
    </h3>
    <p class="mb-4 text-sm text-gray-600">
      Are you sure you want to delete this book? This action cannot be undone.
    </p>

    <div class="flex justify-end gap-3">
      <button
        onclick="closeModal()"
        class="px-4 py-2 text-sm text-gray-700 bg-gray-200 rounded hover:bg-gray-300"
      >
        Cancel
      </button>

      <button
        id="confirmDeleteBtn"
        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded hover:bg-red-700"
      >
        Delete
      </button>
    </div>
  </div>
</div>
</section>

<script>
  const modal = document.getElementById("confirmModal");
  const deleteForm = document.getElementById("deleteBookForm");
  const confirmBtn = document.getElementById("confirmDeleteBtn");

  function openModal() {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  function closeModal() {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  confirmBtn.addEventListener("click", () => {
    deleteForm.submit();
  });


  function enableEdit() {
    document.getElementById("editForm").classList.remove("hidden");

    const noteText = document.getElementById("noteText");
    if (noteText) noteText.classList.add("hidden");

    const editBtn = document.getElementById("editBtn");
    if (editBtn) editBtn.classList.add("hidden");

    const addBtn = document.getElementById("addBtn");
    if (addBtn) addBtn.classList.add("hidden");
  }

</script>

<%- include("partials/footer") %>
